<div class="dashboard-page">
  @if (user$ | async; as user) {
  <h1>Selamat Datang, {{ user.nama }}!</h1>
  <p class="sub-header">Kelola buku pinjaman dan lihat riwayat Anda di sini.</p>

  <section class="dashboard-section">
    <h2>Permintaan Peminjaman Tertunda</h2>
    @if (peminjamanDiminta$ | async; as permintaan) { @if (permintaan.length >
    0) {
    <div class="book-list">
      @for (item of permintaan; track item.docId) {
      <a
        class="book-item book-item-link"
        [routerLink]="['/buku', item.book.id]"
      >
        <img
          [src]="item.book.coverImageUrl"
          [alt]="item.book.title"
          class="book-cover"
        />
        <div class="book-info">
          <h3>{{ item.book.title }}</h3>
          <p>Oleh {{ item.book.author }}</p>
          <p class="due-date">
            Diminta pada:
            <strong>{{ item.tanggalPermintaan | date : "d MMMM yyyy" }}</strong>
          </p>
        </div>
        <button
          (click)="$event.preventDefault(); onCancelRequest(item.docId)"
          class="action-btn cancel-btn"
        >
          Batalkan
        </button>
      </a>
      }
    </div>
    } @else {
    <p class="empty-state">
      Anda tidak memiliki permintaan peminjaman yang tertunda.
    </p>
    } } @else {
    <p class="loading-state">Memuat data...</p>
    }
  </section>

  <section class="dashboard-section ready-pickup">
    <h2>Buku Siap Diambil</h2>
    @if (peminjamanDisetujui$ | async; as disetujui) { @if (disetujui.length >
    0) {
    <div class="book-list">
      @for (item of disetujui; track item.docId) {
      <a
        class="book-item book-item-link"
        [routerLink]="['/buku', item.book.id]"
      >
        <img
          [src]="item.book.coverImageUrl"
          [alt]="item.book.title"
          class="book-cover"
        />
        <div class="book-info">
          <h3>{{ item.book.title }}</h3>
          <p>Oleh {{ item.book.author }}</p>
          <p class="due-date">
            Disetujui pada:
            <strong>{{
              item.tanggalPersetujuan | date : "d MMMM yyyy"
            }}</strong>
          </p>
          <p class="pickup-info">Silakan ambil buku di perpustakaan.</p>
        </div>
      </a>
      }
    </div>
    } @else {
    <p class="empty-state">
      Tidak ada buku yang disetujui dan siap untuk diambil.
    </p>
    } } @else {
    <p class="loading-state">Memuat data...</p>
    }
  </section>

  <section class="dashboard-section">
    <h2>Buku yang Sedang Dipinjam</h2>
    @if (peminjamanAktif$ | async; as peminjaman) { @if (peminjaman.length > 0)
    {
    <div class="book-list">
      @for (item of peminjaman; track item.book.id) {
      <a
        class="book-item book-item-link"
        [class.overdue]="item.isOverdue"
        [routerLink]="['/buku', item.book.id]"
      >
        <img
          [src]="item.book.coverImageUrl"
          [alt]="item.book.title"
          class="book-cover"
        />
        <div class="book-info">
          <h3>{{ item.book.title }}</h3>
          <p>Oleh {{ item.book.author }}</p>
          <p class="due-date">
            Batas Pengembalian:
            <strong>{{ item.tanggalKembali | date : "d MMMM yyyy" }}</strong>
          </p>
          @if (item.isOverdue) {
          <span class="overdue-badge">TERLAMBAT</span>
          }
        </div>
      </a>
      }
    </div>
    } @else {
    <p class="empty-state">Anda sedang tidak meminjam buku.</p>
    } } @else {
    <p class="loading-state">Memuat data...</p>
    }
  </section>

  <section class="dashboard-section">
    <h2>Riwayat Peminjaman</h2>
    @if (isHistoryLoading) {
    <p class="loading-state">Memuat data...</p>
    } @else { @if (allRiwayat.length > 0) {
    <div class="book-list history">
      @for (item of paginatedRiwayat; track item.docId) {
      <a
        class="book-item book-item-link"
        [class.overdue]="item.wasReturnedLate"
        [routerLink]="['/buku', item.book.id]"
      >
        <img
          [src]="item.book.coverImageUrl"
          [alt]="item.book.title"
          class="book-cover"
        />
        <div class="book-info">
          <h3>{{ item.book.title }}</h3>
          <p>Oleh {{ item.book.author }}</p>
          <p class="return-date">
            Dikembalikan pada:
            {{ item.tanggalDikembalikan | date : "d MMMM yyyy" }}
          </p>
          @if (item.wasReturnedLate) {
          <span class="overdue-badge">TERLAMBAT</span>
          }
        </div>
      </a>
      }
    </div>
    <app-pagination
      [totalItems]="historyTotalItems"
      [currentPage]="historyCurrentPage"
      [itemsPerPage]="historyItemsPerPage"
      (pageChanged)="onHistoryPageChanged($event)"
    ></app-pagination>
    } @else {
    <p class="empty-state">Anda belum memiliki riwayat peminjaman.</p>
    } }
  </section>

  } @else {
  <p class="loading-state">Loading data pengguna...</p>
  }
</div>
